name: Build manylinux wheels

on: workflow_dispatch

jobs:
  build-manylinux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build wheels with cibuildwheel
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS: x86_64
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28_x86_64
          CIBW_BUILD: "cp39-* cp310-* cp311-* cp312-*"

          CIBW_ENVIRONMENT: |
            CPPFLAGS="-I/usr/local/include"
            LDFLAGS="-L/usr/local/lib"

          CIBW_BEFORE_ALL_LINUX: |
            dnf install -y epel-release
            dnf install -y fontconfig-devel freetype-devel glfw-devel libjpeg-turbo-devel \
                libpng-devel xz-devel htslib-devel make gcc g++
            
            cd ./gw
            make prep
            CPPFLAGS="-I/usr/include/freetype2" make shared -j$(nproc)
            
            cp libgw/*.* /usr/local/lib
            cp libgw/libskia.a ../gwplot/
            cp -rf libgw/GW /usr/local/include
            
            ls -lh /usr/local/lib/libgw*
            ls -lh /usr/local/lib/libskia.a
            ls -lh /usr/local/include/GW
            ls -lh ./gwplot

          CIBW_TEST_COMMAND: "python -c 'import gwplot'"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels_intel_macOS_manylinux
          path: ./wheelhouse/*.whl