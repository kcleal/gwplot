#!/bin/bash

echo "STARTING MANYLINUX-DEPS"

yum -y groupinstall "Development Tools"
yum -y install glibc-devel
yum -y install gcc gcc-c++ autoconf openssl-devel libffi libffi-devel zlib-devel \
    bzip2-devel bzip2-libs xz-devel xz-libs libffi atlas-devel libjpeg-devel  curl-devel curl \
    cmake  xorg-x11-server-Xorg xorg-x11-xauth xorg-x11-apps libXcursor-devel libXi-devel libXinerama-devel \
    wayland-devel libxkbcommon-devel wayland-protocols-devel libXrandr-devel libssh2 libs3 extra-cmake-modules

# Fix POSIX time error for glfw3
{ echo '#define POSIX_REQUIRED_STANDARD 199309L'; echo '#define _POSIX_C_SOURCE POSIX_REQUIRED_STANDARD'; echo '#define _POSIX_SOURCE POSIX_REQUIRED_STANDARD'; cat  /project/glfw-3.4/src/posix_time.c; } > time.tmp && mv time.tmp  /project/glfw-3.4/src/posix_time.c

curl -L -o glfw-3.4.zip https://github.com/glfw/glfw/releases/download/3.4/glfw-3.4.zip
unzip glfw-3.4.zip && cd glfw-3.4
cmake -S . -B build && cd build && make
ls && cp libglfw3.a /usr/local/lib && cp libglfw3.a /usr/local/lib/libglfw.a
cd ../ && cp -rf include/GLFW3 /usr/local/include
ls /usr/local/include/
ls /usr/local/include/GLFW/


git clone --depth 1 https://github.com/ebiggers/libdeflate.git && \
    cd libdeflate && CFLAGS+=' -fPIC -O3 ' cmake -B build && CFLAGS+=' -fPIC -O3 ' cmake --build build
cp build/libdeflate.a /usr/local/lib && cp libdeflate.h /usr/local/include
cd ../


curl -L -o htslib.tar.bz2 https://github.com/samtools/htslib/releases/download/1.17/htslib-1.17.tar.bz2
ls -lh
tar -xvf htslib.tar.bz2
mv htslib-1.17 htslib && rm htslib.tar.bz2
cd htslib
./configure --enable-libcurl --enable-s3 --enable-lzma --enable-bz2 --with-libdeflate
make && make install
cd ../


pwd
ls

cd gw
make prep
make shared
cp -rf libgw/include ../
cp libgw.* /usr/local/lib
cd ../

echo "MANYLINUX-DEPS DONE"
